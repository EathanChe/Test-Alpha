《血染钟楼·白天私聊管理 Web App 产品说明书（PRD / V1）》

---

# 1. 产品概述

**产品名称（暂定）**：血染大厅（BOTC Day Chat Manager）
**使用场景**：血染钟楼线下局白天私聊阶段，玩家用手机浏览器进入同一大厅，完成公开聊天、私聊申请/私聊，并且大厅对私聊行为进行公开记录与展示；说书人控制白天/黑夜、天数推进、游戏重开与大厅销毁，并可查看完整记录（含私聊内容）。

**形态**：移动端优先的网页（Web App），无需安装、无需注册。

---

# 2. 目标与范围

## 2.1 V1 目标

1. 说书人创建大厅并出现在大厅列表中；玩家从列表选择大厅后输入密码加入。
2. 大厅支持 **第 N 天** + **白天/黑夜** 两种状态；黑夜全禁用玩家操作。
3. 白天支持公开聊天室；**每次进入新白天公开聊天清空**。
4. 白天支持“多选玩家发起私聊申请”，按规则通过后进入多人私聊（抽屉/弹窗）。
5. 大厅对私聊“开始/结束”做记录，并在玩家名字下显示“正在私聊中”；当日私聊历史在“公告板”里查看，避免刷屏。
6. 说书人能查看**所有天**的完整记录（含私聊内容），玩家只能看**当前白天**的公告板。
7. 支持重连：玩家用同昵称+大厅密码可恢复（同名将接管旧会话）。
8. 说书人可随时结束游戏并从第 1 天重新开始（清空所有聊天与公告与私聊记录）。

---

# 3. 核心概念与术语

* **大厅（Hall）**：一场游戏的容器；有密码；在大厅列表可见。
* **阶段（Phase）**：白天 / 黑夜。黑夜时玩家完全不可操作。
* **天（Day）**：白天序号。每次从黑夜切白天自动 +1；进入新白天时玩家侧公开聊天与公告板清空（仅显示当日）。
* **公开聊天（Public Chat）**：大厅内所有玩家可见；按天存储；玩家只看当日。
* **私聊申请（Private Request）**：发起人一次多选多个玩家；30 秒内被选玩家逐一同意/拒绝；超时未处理视为拒绝。
* **私聊会话（Private Session）**：所有同意者（+发起人）组成一个多人私聊；抽屉/弹窗内进行；任一方结束则全体结束。
* **公告板（Bulletin Board）**：记录当日私聊的开始/结束事件；玩家点击进入查看当日历史；说书人可查看全部天。
* **在线列表（Roster）**：展示玩家昵称；并显示“正在私聊中”状态。

---

# 4. 角色与权限

## 4.1 说书人

* 创建大厅（设置：大厅名、密码）
* 控制阶段：结束白天→黑夜；开启白天→自动 Day+1
* 随时“结束游戏并重开”：回到 Day1 + 清空所有聊天/公告/私聊
* 查看在线列表
* 查看完整记录：所有天公开聊天 + 公告板 + 私聊内容
* 结束大厅并销毁（大厅从列表移除）

> 你选择“无管理口令、只能一个说书人”。实现上：**创建大厅的那一端会获得一个不可猜的“说书人会话令牌”并保存在浏览器**，无需再输入口令；同大厅只允许一个令牌拥有说书人权限。

## 4.2 玩家

* 从大厅列表选择大厅，输入密码与昵称加入
* 白天：公开聊天、发起私聊申请、处理被申请的同意/拒绝、进入私聊
* 黑夜：只可查看界面（输入与按钮全禁用）
* 查看当日公告板（私聊开始/结束历史）与玩家私聊中状态

---

# 5. 关键规则（按你已决策固化）

## 5.1 大厅进入与昵称

* 玩家从大厅列表选择大厅 → 输入大厅密码 → 输入昵称加入。
* 昵称 **大厅内唯一**；重复则提示改名。
* 重连：同昵称+密码再次进入 → **新会话接管旧会话**（旧会话强制下线/失效）。

## 5.2 白天/黑夜

* 黑夜：玩家不能聊天、不能申请、不能私聊、不能点任何可操作按钮（全禁用）。
* 从黑夜开启白天：系统自动 Day+1。
* 玩家侧切到新白天：**公开聊天清空、公告板清空、私聊会话清空**（仅显示当日）。
* 说书人可“结束游戏并从 Day1 开始”：清空所有天的聊天与公告与私聊记录（相当于全量 reset）。

## 5.3 私聊申请（30 秒、不可撤回）

* 发起人一次可多选多个玩家，提交一条申请。
* 被选玩家在 30 秒内逐一选择同意/拒绝；未处理到时自动视为拒绝。
* 任一玩家同一时间只能在 **1 个私聊会话**中：
  * 若被申请者“已在私聊中”，其对新申请默认**只能拒绝**（或提示“需先结束当前私聊才能同意”，V1建议直接拒绝并给原因）。
* 申请不可撤回；进入黑夜时所有未完成申请自动取消。

## 5.4 “有人拒绝”的分支

* 30 秒结束后，如果 **全员同意**：自动建群私聊（包含发起人+全部同意者）。
* 如果 **有人拒绝/超时**：发起人看到结果列表，并二选一：
  1. 取消此次私聊（不建群）
  2. 与“同意的玩家”建群私聊（仅同意者 + 发起人）

## 5.5 私聊会话

* 支持多人（申请多选就建群）。
* 私聊在大厅页内以抽屉/弹窗呈现，不离开大厅。
* 任意参与者点击“结束私聊” → 私聊对全体结束。
* 说书人可见私聊内容（用于复盘/裁决）。

## 5.6 公告板与状态展示

* 公告板记录私聊 **开始 + 结束**，时间精度到分钟（HH:MM）。
* 玩家列表中：正在私聊的玩家昵称下显示“正在私聊中”。
* 为避免刷屏：大厅主界面不滚动堆叠大量通知；采用“公告板入口 + 未读点/数量提示 +（可选）轻提示 toast”。

---

# 6. 用户流程

## 6.1 说书人流程

1. 打开网址 → 选择“说书人：创建房间” → 创建大厅（大厅名、密码）
2. 大厅出现在列表 → 玩家加入 
3. 开始游戏：默认 Day1 / 白天（或创建后立即处于白天）
4. 白天中观察在线列表与公告板（含私聊内容/记录）
5. 结束白天→黑夜（玩家全禁用）
6. 开启白天→Day+1（玩家侧清空当日）
7. 结束大厅并销毁（从列表移除）
8. 任意时刻可点“结束游戏并重开”：回 Day1 + 全清空

## 6.2 玩家流程

1. 打开网址 → 选择“我是玩家：浏览大厅”→大厅列表 → 选大厅 → 输入密码 → 输入昵称加入 
2. 白天：公开聊天
3. 发起私聊：多选玩家→提交→等待对方处理
4. 被申请：收到弹窗→同意/拒绝
5. 若建群成功：弹出私聊抽屉→聊天→任意方结束→回大厅
6. 进入黑夜：全部按钮置灰不可用
7. 新白天：聊天与公告板清空，继续流程

---

# 7. 页面与交互（移动端优先）

## 7.1 首页：大厅列表 / 加入

* 大厅列表卡片：大厅名、当前 Day、阶段（白/黑）、在线人数
* 点某大厅：弹出输入框：大厅密码、昵称
* 校验：密码正确 + 昵称唯一 → 进入大厅页
* 入口：切换“说书人模式”（创建大厅按钮）

## 7.2 说书人创建/管理页（可与大厅页合并为顶部“说书人面板”）

* 创建大厅：大厅名、密码
* 状态区：当前 Day、当前阶段
* 控制按钮：
  * 结束白天（→黑夜）
  * 开启白天（→Day+1，→白天）
  * 结束游戏并重开（→Day1，全清空）
  * 结束大厅并销毁
* 查看区：
  * 在线列表
  * 公告板（可切换 Day1/Day2/…）
  * 私聊内容查看（按会话/按天归档）

## 7.3 大厅页（玩家视角）

顶部状态栏：

* “第 N 天 / 白天(或黑夜)”
* 黑夜时覆盖一层遮罩：提示“黑夜中，等待说书人开启白天”

主体区域：

1. 在线玩家列表（可滚动）
   * 每个玩家：昵称 +（正在私聊中标记）+（可选：是否在线）
2. 公开聊天区（当日）
   * 消息列表 + 输入框（黑夜禁用）
3. 私聊申请区
   * 多选玩家控件（排除自己、排除已在私聊中的玩家或标注不可选）
   * “发起私聊申请”按钮
4. 公告板入口
   * 按钮“公告板（当日）”
   * 可显示未读点/数量

弹窗/抽屉：

* 私聊抽屉：会话成员列表、消息流、输入框、结束按钮
* 被申请弹窗：显示发起人+参与名单+倒计时，同意/拒绝
* 申请结果弹窗（发起人）：显示同意/拒绝/超时名单 → “取消 / 与同意者私聊”

公告板抽屉：

* 列表按时间倒序：
  * HH:MM  A、B、C 开始私聊
  * HH:MM  A、B、C 结束私聊

---

# 8. 数据结构（建议的实体）

## 8.1 Hall（大厅）

* hallId
* name
* passwordHash
* status: active / destroyed
* phase: DAY / NIGHT
* dayNumber: int
* storytellerSessionToken（仅服务端存储）
* createdAt / updatedAt

## 8.2 Player（玩家会话）

* playerId
* hallId
* nickname（唯一）
* isOnline
* lastSeenAt
* activePrivateSessionId（若在私聊中）
* role: PLAYER / STORYTELLER（仅一个）

## 8.3 PublicMessage（公开消息）

* msgId
* hallId
* dayNumber
* senderNickname
* content
* createdAt

## 8.4 PrivateRequest（私聊申请）

* requestId
* hallId
* dayNumber
* initiatorNickname
* targetNicknames[]
* status: PENDING / READY_TO_DECIDE / CANCELED / EXPIRED / ACCEPTED_TO_SESSION
* expiresAt（创建+30秒）
* responses: { nickname: ACCEPT / REJECT / TIMEOUT }
* createdAt

## 8.5 PrivateSession（私聊会话）

* sessionId
* hallId
* dayNumber
* participantsNicknames[]
* status: ACTIVE / ENDED
* startedAt
* endedAt
* endedByNickname（谁点的结束）

## 8.6 PrivateMessage（私聊消息）

* msgId
* sessionId
* senderNickname
* content
* createdAt

## 8.7 BulletinEvent（公告板事件）

* eventId
* hallId
* dayNumber
* type: PRIVATE_START / PRIVATE_END
* participantsNicknames[]
* timeHHMM（展示用）
* createdAt

> 存储策略：玩家侧“清空”是 UI 只展示当前 dayNumber 的集合；服务端仍保存所有天记录，供说书人查看；“重开游戏”则服务端真正清空所有集合并回 Day1。

---

# 9. 状态机与事件规则

## 9.1 阶段切换

* DAY → NIGHT：立即终止所有未完成申请（置为 canceled）
* NIGHT → DAY：dayNumber += 1；玩家侧展示集合切换到新 dayNumber

## 9.2 私聊申请超时

* 到 expiresAt：对未响应者标 TIMEOUT（视为拒绝）
* 进入 READY_TO_DECIDE：发起人收到“结果弹窗”，选择取消或与同意者开聊
* 若发起人不操作：可设置 30 秒自动默认取消（V1建议默认取消，避免悬挂）

## 9.3 私聊会话结束

* 任意一方点结束：session.status=ENDED，生成公告板 PRIVATE_END 事件，所有参与者 activePrivateSessionId 清空，私聊抽屉关闭

---

# 10. 异常与边界情况处理（V1 必须明确）

1. **同昵称接管**：后登录者生效，前登录者立刻失效并提示“你已在其他设备登录”。
2. **申请对象有人已在私聊中**：默认不可选/或选了会在提交时提示并从名单剔除。
3. **黑夜时仍有人在私聊**：切黑夜时强制结束所有私聊会话，并生成 PRIVATE_END（endedBy=SYSTEM）。
4. **多人申请的并发冲突**：同一玩家一次只能在一个私聊中，所以当其同意某个申请后，其他申请自动变为“该玩家不可同意/已占用”并判拒绝。
5. **大厅销毁**：所有连接断开，回到首页并提示“大厅已结束”。
6. **说书人掉线**：大厅仍存在；说书人使用原浏览器重连即可恢复控制（基于会话令牌）。若说书人换设备，V1 不支持接管（因为你不想要口令体系）。

---

# 11. 非功能需求（体验底线）

* **实时性**：聊天/申请/公告板更新需接近实时（建议 WebSocket）。
* **移动端适配**：按钮大、输入框不被键盘遮挡、抽屉可单手操作。
* **性能**：支持 5–20 人同时在线流畅（典型桌游规模）。
* **可用性**：断线自动重连；网络差时提示“连接中”。
* **隐私**：玩家看不到他人私聊内容；说书人可见（已确认）。
* **安全最低线**：大厅密码不明文存储；说书人令牌不可猜测。

---

# 12. 验收标准（你用来判断“做完了没”）

1. 能创建大厅并出现在列表；玩家能输入密码加入且昵称唯一。
2. 白天公开聊天可用；切到新白天公开聊天清空。
3. 黑夜全禁用玩家操作；切黑夜强制结束私聊与取消申请。
4. 私聊申请多选可用；30 秒倒计时；超时视为拒绝；拒绝后发起人可选择“取消/仅与同意者私聊”。
5. 私聊抽屉可用；任一方结束全体结束。
6. 公告板能查看当日私聊开始/结束历史；玩家名下能显示“正在私聊中”。
7. 说书人可查看所有天记录与私聊内容；玩家只能看当日。
8. “结束游戏并重开”能回 Day1 且清空所有聊天与公告与私聊记录。
